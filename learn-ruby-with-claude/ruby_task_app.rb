############################################
# This code is generated by claude.ai, 2025/07/27
# Author: claude.ai and me
############################################
#!/usr/bin/env ruby
# encoding: utf-8

require 'json'
require 'date'

class TaskManager
  def initialize(data_file = 'tasks.json')
    @data_file = data_file
    @tasks = load_tasks
  end

  def load_tasks
    return [] unless File.exist?(@data_file)
    
    begin
      JSON.parse(File.read(@data_file))
    rescue JSON::ParserError
      []
    end
  end

  def save_tasks
    File.write(@data_file, JSON.pretty_generate(@tasks))
  end

  def add_task(title, description = '')
    task = {
      'id' => generate_id,
      'title' => title,
      'description' => description,
      'completed' => false,
      'created_at' => DateTime.now.strftime('%Y-%m-%d %H:%M:%S')
    }
    @tasks << task
    save_tasks
    puts "âœ… ã‚¿ã‚¹ã‚¯ã€Œ#{title}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸ"
  end

  def list_tasks
    if @tasks.empty?
      puts "ğŸ“ ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“"
      return
    end

    puts "\nğŸ“‹ ã‚¿ã‚¹ã‚¯ä¸€è¦§:"
    puts "-" * 50
    @tasks.each_with_index do |task, index|
      status = task['completed'] ? 'âœ“' : 'â—‹'
      puts "#{index + 1}. [#{status}] #{task['title']}"
      puts "   #{task['description']}" unless task['description'].empty?
      puts "   ä½œæˆæ—¥: #{task['created_at']}"
      puts
    end
  end

  def complete_task(index)
    if index < 1 || index > @tasks.length
      puts "âŒ ç„¡åŠ¹ãªã‚¿ã‚¹ã‚¯ç•ªå·ã§ã™"
      return
    end

    task = @tasks[index - 1]
    task['completed'] = true
    save_tasks
    puts "ğŸ‰ ã‚¿ã‚¹ã‚¯ã€Œ#{task['title']}ã€ã‚’å®Œäº†ã—ã¾ã—ãŸï¼"
  end

  def delete_task(index)
    if index < 1 || index > @tasks.length
      puts "âŒ ç„¡åŠ¹ãªã‚¿ã‚¹ã‚¯ç•ªå·ã§ã™"
      return
    end

    task = @tasks.delete_at(index - 1)
    save_tasks
    puts "ğŸ—‘ï¸  ã‚¿ã‚¹ã‚¯ã€Œ#{task['title']}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ"
  end

  def show_stats
    total = @tasks.length
    completed = @tasks.count { |task| task['completed'] }
    pending = total - completed
    
    puts "\nğŸ“Š çµ±è¨ˆæƒ…å ±:"
    puts "å…¨ã‚¿ã‚¹ã‚¯æ•°: #{total}"
    puts "å®Œäº†æ¸ˆã¿: #{completed}"
    puts "æœªå®Œäº†: #{pending}"
    puts "å®Œäº†ç‡: #{total > 0 ? (completed.to_f / total * 100).round(1) : 0}%"
  end

  private

  def generate_id
    Time.now.to_i.to_s + rand(1000).to_s
  end
end

class TaskApp
  def initialize
    @task_manager = TaskManager.new
    @running = true
  end

  def run
    puts "ğŸ¯ Ruby ã‚¿ã‚¹ã‚¯ç®¡ç†ã‚¢ãƒ—ãƒªã¸ã‚ˆã†ã“ãï¼"
    
    while @running
      show_menu
      choice = gets.chomp.to_i
      handle_choice(choice)
    end
  end

  private

  def show_menu
    puts "\n" + "=" * 40
    puts "ä½•ã‚’ã—ã¾ã™ã‹ï¼Ÿ"
    puts "1. ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ "
    puts "2. ã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’è¡¨ç¤º"
    puts "3. ã‚¿ã‚¹ã‚¯ã‚’å®Œäº†"
    puts "4. ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤"
    puts "5. çµ±è¨ˆæƒ…å ±ã‚’è¡¨ç¤º"
    puts "6. çµ‚äº†"
    puts "=" * 40
    print "é¸æŠã—ã¦ãã ã•ã„ (1-6): "
  end

  def handle_choice(choice)
    case choice
    when 1
      add_task
    when 2
      @task_manager.list_tasks
    when 3
      complete_task
    when 4
      delete_task
    when 5
      @task_manager.show_stats
    when 6
      puts "ğŸ‘‹ ã•ã‚ˆã†ãªã‚‰ï¼"
      @running = false
    else
      puts "âŒ 1-6ã®æ•°å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
    end
  end

  def add_task
    print "ã‚¿ã‚¹ã‚¯ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›: "
    title = gets.chomp
    
    return if title.empty?
    
    print "èª¬æ˜ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰: "
    description = gets.chomp
    
    @task_manager.add_task(title, description)
  end

  def complete_task
    @task_manager.list_tasks
    return if @task_manager.instance_variable_get(:@tasks).empty?
    
    print "å®Œäº†ã™ã‚‹ã‚¿ã‚¹ã‚¯ã®ç•ªå·ã‚’å…¥åŠ›: "
    index = gets.chomp.to_i
    @task_manager.complete_task(index)
  end

  def delete_task
    @task_manager.list_tasks
    return if @task_manager.instance_variable_get(:@tasks).empty?
    
    print "å‰Šé™¤ã™ã‚‹ã‚¿ã‚¹ã‚¯ã®ç•ªå·ã‚’å…¥åŠ›: "
    index = gets.chomp.to_i
    @task_manager.delete_task(index)
  end
end

# macOSç‰¹æœ‰ã®æ©Ÿèƒ½ã‚’è¿½åŠ 
class MacOSFeatures
  def self.send_notification(title, message)
    system("osascript -e 'display notification \"#{message}\" with title \"#{title}\"'")
  end

  def self.open_finder(path = '.')
    system("open #{path}")
  end

  def self.speak(text)
    system("say '#{text}'")
  end
end

# é€šçŸ¥æ©Ÿèƒ½ä»˜ãã®ã‚¿ã‚¹ã‚¯ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼
class NotifyingTaskManager < TaskManager
  def add_task(title, description = '')
    super
    MacOSFeatures.send_notification("ã‚¿ã‚¹ã‚¯è¿½åŠ ", "ã€Œ#{title}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸ")
  end

  def complete_task(index)
    return unless index >= 1 && index <= @tasks.length
    
    task_title = @tasks[index - 1]['title']
    super
    MacOSFeatures.send_notification("ã‚¿ã‚¹ã‚¯å®Œäº†", "ã€Œ#{task_title}ã€ã‚’å®Œäº†ã—ã¾ã—ãŸï¼")
    MacOSFeatures.speak("ã‚¿ã‚¹ã‚¯å®Œäº†")
  end
end

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®èµ·å‹•
if __FILE__ == $0
  begin
    # é€šçŸ¥æ©Ÿèƒ½ã‚’ä½¿ã„ãŸã„å ´åˆã¯ NotifyingTaskManager ã‚’ä½¿ç”¨
    # app = TaskApp.new
    # app.run
    
    # ã¾ãŸã¯ç›´æ¥å®Ÿè¡Œ
    task_manager = TaskManager.new
    
    # ã‚µãƒ³ãƒ—ãƒ«ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ï¼ˆåˆå›å®Ÿè¡Œæ™‚ï¼‰
    if task_manager.instance_variable_get(:@tasks).empty?
      puts "ğŸ‰ åˆå›èµ·å‹•ã§ã™ï¼ã‚µãƒ³ãƒ—ãƒ«ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ã—ã¾ã™"
      task_manager.add_task("Rubyã‚¢ãƒ—ãƒªã®ãƒ†ã‚¹ãƒˆ", "ã“ã®ã‚¿ã‚¹ã‚¯ç®¡ç†ã‚¢ãƒ—ãƒªã‚’è©¦ã—ã¦ã¿ã‚‹")
      task_manager.add_task("macOSã®é€šçŸ¥æ©Ÿèƒ½ã‚’ç¢ºèª", "é€šçŸ¥ãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã‹ãƒ†ã‚¹ãƒˆ")
    end
    
    # ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãƒ¢ãƒ¼ãƒ‰ã‚’é–‹å§‹
    TaskApp.new.run
    
  rescue Interrupt
    puts "\nğŸ‘‹ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’çµ‚äº†ã—ã¾ã™"
  rescue => e
    puts "âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: #{e.message}"
  end
end
